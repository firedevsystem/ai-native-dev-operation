---
title: "レビューの3層構造 ── 品質ゲートと安全ゲートの設計"
emoji: "✅"
type: "tech"
topics: ["ai", "コードレビュー", "セキュリティ", "開発手法", "品質管理"]
published: false
---

# 第6章：レビューの3層構造 ── 品質ゲートと安全ゲート

> **AIネイティブ開発 連載目次**
> 序章 / 第1章 / 第2章 / 第3章 / 第4章 / 第5章 / **第6章（この記事）** / 第7章

---

## AIがレビューする時代のレビュー設計

AIネイティブ開発では、コードレビューもAIが実行する。

これを聞いて「AIにレビューを任せて大丈夫なのか」と思うかもしれない。正しい懸念だ。だからこそ、レビューの構造を設計する必要がある。

本手法では、**3層のレビュー構造**を採用する。

```
コーディングエージェント → 実装を出力
         ↓
コードレビュアー → 7つのレビュー視点で品質レビュー（品質ゲート）
         ↓
システム監査官 → 安全性・安定性・可用性の独立監査（安全ゲート）
         ↓
オペレーター → 両方のサマリーを読み、承認 or 差し戻しを判断
```

実装は2つの独立したゲート（品質ゲート・安全ゲート）を通過して初めてオペレーターの判断に届く。

## なぜ2つのゲートなのか

品質ゲート（コードレビュアー）と安全ゲート（システム監査官）を分離する理由は、第2章で述べた通り「レンズの違い」だ。

- **品質ゲート：** きれいか。保守しやすいか。設計意図が読み取れるか。変更に強いか。
- **安全ゲート：** 安全か。壊れないか。リソースを食い尽くさないか。

この2つのレンズは、同時に適用しようとすると片方が弱くなる。美しいコードを追求するレビュアーはセキュリティホールを見落としがちで、セキュリティに厳しいレビュアーは可読性の問題をスルーしがちだ。

だから分離する。それぞれの専門レンズで独立に検証し、両方のゲートを通過したものだけが先に進む。

## 品質ゲート：7つのレビュー視点

コードレビュアーが使用する7つのレビュー視点を解説する。

### 1. 冗長性排除

- 責務の重複がないか（**行数ではなく責務で判断**する）
- 統合すべきか分離すべきかは、関数の役割の意味的境界で判断する

ここで重要なのは「行数で判断しない」という点だ。3行のコードが2箇所にあっても、それぞれ異なる責務を担っていれば統合すべきではない。逆に、50行の関数が1つであっても、内部に複数の責務が混在していれば分離すべきだ。

### 2. 変更耐性

- 分岐の種類が増える可能性を確認済みか
- 未確認なら**実装を止めて確認させる**
- 増える場合は固定値を避けてenum等の定義で動かす設計にする

「今は3種類だけど将来増えるかも」は、確認すべきシグナルだ。確認もせずにif-elseで3種類をハードコードするのは変更耐性が低い。

### 3. エラーハンドリング

- ユーザーの意図が完遂できなかった場合の処理が設計されているか
- **条件未達** → 理由明示＋アクション誘導
- **システムエラー** → 概要通知＋自動復旧 or 人的サポート誘導
- クリティカルログは無条件取得、ワーニングは取得可能な設計か

エラーハンドリングの設計は最上位原則「ユーザーの意図を完遂させる」に直結する。ユーザーが何かをしようとして失敗したとき、「エラーが発生しました」だけでは意図は完遂できない。なぜ失敗したのか、次に何をすればいいのかを示すことが必要だ。

### 4. パフォーマンス

- UI体感基準：初期表示200ms以下、検索結果100ms以下
- 超過する場合は非同期処理＋完了通知で体感を補償する

数字の根拠は、ユーザーが「待たされている」と感じるかどうかだ。200msを超えると人間は遅延を知覚し始める。この基準を超える場合は、ローディング表示や非同期処理で「処理中である」ことを伝え、体感を補償する。

### 5. リソースコスト

- 同居システムへの影響、CPU/メモリ占有率の設定
- ファイル出力の永久増加リスク、ローテートの有無
- メモリリーク・無限ループ・デッドロックの危険の検出

見落とされがちだが、ログファイルが無制限に増え続ける設計は本番環境でディスクを食い尽くす。バッチ処理がメモリを解放せずに肥大化する。これらは機能的には「動いている」が、運用上は時限爆弾だ。

### 6. セキュリティ

- データ機密度に応じたレビュー深度（個人情報・決済情報は最深度）
- データ保管の暗号化、アクセス経路の制御
- フロントのクレデンシャル露出

Phase 3で特定したデータ機密度に応じて、レビューの深度が変わる。個人情報や決済情報を扱う場合は最も深いレベルでの検証を行う。

### 7. 可読性

- マジックナンバー禁止（enum等で定義する）
- フォルダ構成に設計意図があるか
- 1メソッド・1クラスの肥大化がないか
- 他者が読んで意図がわかるか

可読性は「今の自分が読めるか」ではなく「半年後の他者が読んで意図がわかるか」で判断する。

## 安全ゲート：システム監査官の観点

システム監査官は、コードレビュアーとは独立した観点で検証する。

品質ゲートが「良いコードか」を問うのに対して、安全ゲートは「危険なコードではないか」を問う。

- **安全性：** セキュリティホール、インジェクション、認証・認可の不備
- **安定性：** 障害時の挙動、復旧手順、データ整合性の保証
- **可用性：** 単一障害点の有無、スケーラビリティの確保

システム監査官の指摘は、全ロールに対して最優先で適用される。セキュリティの問題が見つかった場合、進捗が遅れようがコードが美しかろうが、対応は必須だ。

## オペレーターのレビュー判断

オペレーターはコードを逐行レビューしない。品質ゲートと安全ゲートの**サマリーを読んで判断する**。

### 確認すべき4つのポイント

1. **7視点すべてがサマリーに含まれているか。** 視点の欠落がないかを確認する。「パフォーマンスについて言及がない」なら、その視点での検証が行われていない可能性がある。

2. **各視点の判定根拠が具体的か。** 「問題なし」だけでは不十分だ。何を確認して問題なしと判断したかが明示されている必要がある。

3. **指摘事項の重要度判定が妥当か。** セキュリティやリソースコストの問題が「軽微」扱いされていないかを特に注意する。

4. **自分の業務文脈の知識から見て、見落とされている観点がないか。** AIが業界固有の制約や既存システムとの整合性を見落としている可能性がある。ここがオペレーターのドメイン知識が活きるポイントだ。

### AIのレビュー結果を無条件で受け入れない

これは最も重要な原則だ。

AIのレビュー結果が「全項目OK」だったとしても、オペレーターは「本当にOKか」を自分の判断で評価する。サマリーの内容に疑問があれば、該当箇所の深掘りレビューを指示する。

:::message alert
AIのレビュー結果が「全項目OK」だったとしても、オペレーターは「本当にOKか」を自分の判断で評価する。サマリーの内容に疑問があれば、該当箇所の深掘りレビューを指示する。「AIがOKと言ったから大丈夫」は、この手法では許容されない。
:::

---

**← 前の記事：** 第5章 Phase 6〜8：フィードバックからフルスケールへ
**→ 次の記事：** 第7章 壁打ちの非対称性と横断的品質原則
